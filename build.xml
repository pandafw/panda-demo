<?xml version="1.0" encoding="UTF-8"?>
<project name="panda-demo" default="usage" basedir=".">
	<property name="prj.repo" location="../panda-repo"/>
	<property name="app.dir" value="/opt/apps/pdemo"/>
	<property name="web.dir" value="${app.dir}/web"/>
	<property name="log.dir" value="${app.dir}/log"/>

	<!-- load properties -->
	<property file="src/main/resources/app.properties"/>

	<tstamp>
		<format property="TODAY" pattern="yyyy-MM-dd HH:mm:ss"/>
	</tstamp>

	<!-- version -->
	<import file="../panda-java/ant/panda-version.xml"/>

	<!-- dependency -->
	<path id="dep.cp">
		<pathelement path="../panda-wing/out/classes"/>
		<pathelement path="../panda-gear/out/classes"/>
		<pathelement path="../panda-java/out/classes"/>
		<path refid="lib.cp"/>
	</path>

	<!-- usage -->
	<target name="usage">
		<echo><![CDATA[
${prj.name}-${VERSION} build file
-----------------------------------

Available targets are:

build        --> Build the project (clean, cp-fonts, cp-res, javac)
clean        --> Delete everything in the output directory
cp-fonts     --> Copy fonts to the web/WEB-INF/fonts directory
cp-res       --> Copy resource files to the classes directory
dist         --> Distribute the project as a war file (javadoc, war)
gen-all      --> Generate all source files (gen-clean, gen-java, gen-ftl, gen-res)"/>
gen-clean    --> Delete all generated files"/>
gen-ftl      --> Generate freemarker source files"/>
gen-java     --> Generate java source files"/>
gen-res      --> Generate resource bundle source files"/>
ivy-resolve  --> Retreive dependencies
ivy-report   --> Generates a report of dependencies
ivy-clean    --> Clean the cache
javac        --> Compile java source files
javadoc      --> Generate java documents
release      --> Release the project
test         --> Test the project (test-build, test-run, test-report)
test-build   --> Build the test suite of project (test-clean, test-rescp, test-emma, test-javac)
test-clean   --> Delete test output files in the output directory
test-emma    --> EMMA instruments main classes
test-javac   --> Compile test java source files
test-javadoc --> Generate test java documents
test-report  --> Build the test report
test-rescp   --> Copy test resource to the test classes directory
test-run     --> Run all junit test case
war          --> Distribute the project as a war file
]]>
		</echo>
	</target>

	<!-- ivy -->
	<import file="../panda-java/ant/prj-ivy.xml"/>
	
	<!-- code generate -->
	<import file="../panda-gear/ant/prj-codegen.xml"/>

	<!-- build -->
	<import file="../panda-java/ant/prj-build.xml"/>


	<target name="build" depends="clean, cp-fonts, cp-res, n2a, javac, javadoc" description="Build the project"/>

	<!-- dist -->
	<target name="war" description="Distribute the project as a war file">
		<delete includeemptydirs="true">
			<fileset dir="out">
				<include name="war/**"/>
				<include name="${prj.name}-*.war"/>
			</fileset>
		</delete>

		<copy todir="out/war" preservelastmodified="true">
			<fileset dir="web">
				<include name="**/*"/>
				<exclude name="WEB-INF/_*/**"/>
			</fileset>
		</copy>
		<copy file="LICENSE" todir="out/war/META-INF" overwrite="true" force="true"/>
		<copy file="ivy.xml" todir="out/war/META-INF" overwrite="true" force="true"/>

		<manifest file="out/war/META-INF/MANIFEST.MF">
			<attribute name="Created-By" value="${prj.org}"/>
			<attribute name="Built-By" value="${prj.org}"/>
			<attribute name="Built-Date" value="${TODAY}"/>
			<attribute name="Implementation-Title" value="${prj.title}"/>
			<attribute name="Implementation-Version" value="${VERSION}"/>
			<attribute name="Implementation-Vendor" value="${prj.url}"/>
		</manifest>

		<copy todir="out/war/WEB-INF/classes" preservelastmodified="true">
			<fileset dir="out/classes">
				<include name="**/*"/>
			</fileset>
		</copy>
		<replaceregexp file="out/war/WEB-INF/classes/app.properties"
			match="#prj.version=.*"
			replace="prj.version=${prj.version}"
			byline="true"
			encoding="ISO-8859-1"/>
		<replaceregexp file="out/war/WEB-INF/classes/app.properties"
			match="prj.revision=.*"
			replace="prj.revision=${REVISION}"
			byline="true"
			encoding="ISO-8859-1"/>
		<replaceregexp file="out/war/WEB-INF/classes/app.properties"
			match="app.version=.*"
			replace="app.version=${VERSION}"
			byline="true"
			encoding="ISO-8859-1"/>
		<replaceregexp file="out/war/WEB-INF/classes/app.properties" 
			match="task.port=\d*"
			replace="task.port=80"
			byline="true"
			encoding="ISO-8859-1"/>
		<replaceregexp file="out/war/WEB-INF/classes/log4j.properties"
			match="(debug)|(trace)"
			replace="info"
			byline="true"
			encoding="ISO-8859-1"/>
		<replaceregexp file="out/war/WEB-INF/classes/log4j.properties"
			match="log4j.rootLogger=warn, stdout"
			replace="log4j.rootLogger=warn, dailyfile, smtp"
			byline="true"
			encoding="ISO-8859-1"/>
		<replaceregexp file="out/war/WEB-INF/classes/log4j.properties"
			match="\{VERSION\}"
			replace="${VERSION}"
			byline="true"
			encoding="ISO-8859-1"/>
		<replaceregexp file="out/war/WEB-INF/classes/freemarker.properties"
			match="template_update_delay=.*"
			replace="template_update_delay=60000"
			byline="true"
			encoding="ISO-8859-1"/>
		<replaceregexp file="out/war/WEB-INF/classes/app.properties"
			match="site.cdn=.*"
			replace="site.cdn=true"
			byline="true"
			encoding="ISO-8859-1"/>
		<replaceregexp file="out/war/WEB-INF/classes/app.properties"
			match="site.debug=.*"
			replace="site.debug=false"
			byline="true"
			encoding="ISO-8859-1"/>
		<replaceregexp file="out/war/WEB-INF/web.xml"
			match="&lt;!\-\- debug start --&gt;"
			replace="&lt;!-- debug start -"
			byline="true"/>
		<replaceregexp file="out/war/WEB-INF/web.xml"
			match="&lt;!\-\- debug end --&gt;"
			replace="- debug end --&gt;"
			byline="true"/>
		<replaceregexp file="out/war/WEB-INF/web.xml"
			match="&lt;!\-\- release start -"
			replace="&lt;!-- release start --&gt;"
			byline="true"/>
		<replaceregexp file="out/war/WEB-INF/web.xml"
			match="- release end \-\-&gt;"
			replace="&lt;!-- release end --&gt;"
			byline="true"/>

		<copy todir="out/war/WEB-INF/lib" preservelastmodified="true">
			<fileset dir="lib/run">
				<include name="activation.jar"/>
				<include name="commons-email.jar"/>
				<include name="commons-logging.jar"/>
				<include name="dom4j.jar"/>
				<include name="flying-saucer-core.jar"/>
				<include name="flying-saucer-pdf-itext5.jar"/>
				<include name="freemarker.jar"/>
				<include name="itextpdf.jar"/>
				<include name="itext-asian.jar"/>
				<include name="jtidy.jar"/>
				<include name="log4j.jar"/>
				<include name="mail.jar"/>
				<include name="poi.jar"/>
				<include name="poi-ooxml.jar"/>
				<include name="poi-ooxml-schemas.jar"/>
				<include name="xmlbeans.jar"/>
			</fileset>
			<fileset dir="${prj.repo}/com/foolite/panda-wing/${prj.version}">
				<include name="panda-wing-${prj.version}.jar"/>
			</fileset>
			<fileset dir="${prj.repo}/com/foolite/panda-gear/${prj.version}">
				<include name="panda-gear-${prj.version}.jar"/>
			</fileset>
			<fileset dir="${prj.repo}/com/foolite/panda-java/${prj.version}">
				<include name="panda-java-${prj.version}.jar"/>
			</fileset>
		</copy>

		<war destfile="out/${prj.name}-${VERSION}.war"
			manifest="out/war/META-INF/MANIFEST.MF">
			<fileset dir="out/war"/>
		</war>
	</target>

	<target name="dist" depends="jardoc, jarsrc, war" description="Distribute the project as a war file"/>

	<!-- deploy -->
	<target name="deploy" description="Deploy war to www">
		<mkdir dir="${web.dir}"/>
		<mkdir dir="${log.dir}"/>

		<delete includeemptydirs="true">
			<fileset dir="${web.dir}"/>
		</delete>

		<copy todir="${web.dir}" preservelastmodified="true">
			<fileset dir="out/war"/>
		</copy>

		<replaceregexp file="${web.dir}/WEB-INF/classes/log4j.properties" 
			match="logs/pdemo.log"
			replace="${log.dir}/pdemo.log"
			byline="true"
			encoding="ISO-8859-1"/>

		<!--
		<war destfile="${app.dir}/${prj.name}-${VERSION}.war">
			<fileset dir="${web.dir}"/>
		</war>
		-->
	</target>

	<!-- test -->
	<import file="../panda-java/ant/prj-test.xml"/>
	
	<!-- release -->
	<target name="release" description="Release the project">
		<antcall target="ivy-resolve"/>
		<antcall target="gen-all"/>
		<antcall target="build"/>
		<antcall target="dist"/>
	</target>

</project>
